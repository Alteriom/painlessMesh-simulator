name: CI
permissions:
  contents: read

on:
  push:
    branches: [ master, main, develop, 'feature/**' ]
  pull_request:
    branches: [ master, main, develop ]
  schedule:
    # Run nightly stress tests at 2 AM UTC
    - cron: '0 2 * * *'

env:
  BUILD_TYPE: Release

jobs:
  # Linting and code quality checks
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format cppcheck
      
      - name: Check code formatting
        run: |
          # Check if any C++ files need formatting
          if [ -d "src" ] || [ -d "include" ] || [ -d "test" ]; then
            find src include test -type f \( -name "*.cpp" -o -name "*.hpp" -o -name "*.h" \) 2>/dev/null \
              -exec clang-format --dry-run --Werror {} + || echo "No formatting issues found"
          else
            echo "Source directories not yet created"
          fi
        continue-on-error: true
      
      - name: Run static analysis
        run: |
          # Run cppcheck on source files
          if [ -d "src" ] && [ -d "include" ]; then
            cppcheck --enable=warning,style,performance,portability \
              --suppress=missingIncludeSystem \
              --inline-suppr \
              --error-exitcode=0 \
              src/ include/ 2>&1 | tee cppcheck-report.txt
          else
            echo "Source directories not yet created" | tee cppcheck-report.txt
          fi
        continue-on-error: true
      
      - name: Upload analysis results
        uses: actions/upload-artifact@v6
        with:
          name: static-analysis
          path: cppcheck-report.txt
        if: always()

  # Build using Docker
  build-docker:
    name: Build (Docker)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [Debug, Release]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          docker build --target builder -t painlessmesh-simulator:builder .
      
      - name: Build project in Docker
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/build \
            -w /build \
            painlessmesh-simulator:builder \
            bash -c "mkdir -p build && cd build && \
              cmake -G Ninja \
                -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
                .. && \
              ninja"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: simulator-docker-${{ matrix.build_type }}
          path: |
            build/bin/*
            build/lib/*.a
        if: success()

  # Run unit tests using Docker
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build-docker
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          docker build --target builder -t painlessmesh-simulator:builder .
      
      - name: Build and run tests in Docker
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/build \
            -w /build \
            painlessmesh-simulator:builder \
            bash -c "mkdir -p build && cd build && \
              cmake -G Ninja \
                -DCMAKE_BUILD_TYPE=Debug \
                -DENABLE_TESTING=ON \
                -DENABLE_COVERAGE=ON \
                .. && \
              ninja && \
              ctest --output-on-failure --verbose"
      
      - name: Generate coverage report
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/build \
            -w /build/build \
            painlessmesh-simulator:builder \
            bash -c "apt-get update && apt-get install -y lcov && \
              lcov --capture --directory . --output-file coverage.info && \
              lcov --remove coverage.info '/usr/*' --output-file coverage.info && \
              lcov --list coverage.info"
        continue-on-error: true
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: build/coverage.info
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

  # Integration tests with example scenarios using Docker
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-docker
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          docker build --target builder -t painlessmesh-simulator:builder .
      
      - name: Build project in Docker
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/build \
            -w /build \
            painlessmesh-simulator:builder \
            bash -c "mkdir -p build && cd build && \
              cmake -G Ninja .. && \
              ninja"
      
      - name: Run basic validation
        run: |
          # Run simple mesh scenario
          docker run --rm \
            -v ${{ github.workspace }}:/build \
            -w /build \
            painlessmesh-simulator:builder \
            bash -c "./build/bin/painlessmesh-simulator --config examples/scenarios/simple_mesh.yaml --duration 30 --log-level INFO"
          
          # Verify the simulator ran successfully
          if [ $? -eq 0 ]; then
            echo "✓ Simple mesh scenario completed successfully"
          else
            echo "✗ Simple mesh scenario failed"
            exit 1
          fi
      
      - name: Upload test results
        uses: actions/upload-artifact@v6
        with:
          name: integration-test-results
          path: results/
        if: always()

  # Performance benchmarks using Docker
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: build-docker
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[benchmark]')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          docker build --target builder -t painlessmesh-simulator:builder .
      
      - name: Build project in Docker
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/build \
            -w /build \
            painlessmesh-simulator:builder \
            bash -c "mkdir -p build && cd build && \
              cmake -G Ninja \
                -DCMAKE_BUILD_TYPE=Release \
                -DENABLE_BENCHMARKS=ON \
                .. && \
              ninja"
      
      - name: Run benchmarks
        run: |
          # Run stress test scenario at 5x speed
          docker run --rm \
            -v ${{ github.workspace }}:/build \
            -w /build \
            painlessmesh-simulator:builder \
            bash -c "./build/bin/painlessmesh-simulator --config examples/scenarios/stress_test.yaml --duration 60 --time-scale 5.0 --log-level WARN"
          
          echo "Benchmark completed - check results directory for metrics"
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-results
          path: results/
        if: always()

  # Documentation build check
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz
      
      - name: Generate documentation
        run: |
          # Will generate once Doxyfile is created
          echo "Documentation generation will be enabled when Doxyfile is added"
          # Future: doxygen Doxyfile
      
      - name: Upload documentation
        uses: actions/upload-artifact@v6
        with:
          name: documentation
          path: docs/html/
        if: always()

  # Security scanning - Disabled because GitHub default CodeQL is enabled
  # If you need custom CodeQL configuration, disable the default CodeQL in repository settings
  # and uncomment this job
  # security:
  #   name: Security Scan
  #   runs-on: ubuntu-latest
  #   
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v6
  #       with:
  #         submodules: recursive
  #     
  #     - name: Run CodeQL analysis
  #       uses: github/codeql-action/init@v3
  #       with:
  #         languages: cpp
  #     
  #     - name: Install dependencies
  #       run: |
  #         sudo apt-get update
  #         sudo apt-get install -y \
  #           cmake \
  #           ninja-build \
  #           libboost-dev \
  #           libboost-system-dev \
  #           libyaml-cpp-dev
  #     
  #     - name: Build for analysis
  #       run: |
  #         cmake -G Ninja -B build
  #         cmake --build build
  #     
  #     - name: Perform CodeQL Analysis
  #       uses: github/codeql-action/analyze@v3

  # All checks passed
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, build-docker, test]
    if: always()
    
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.build-docker.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "One or more CI jobs failed"
            exit 1
          fi
          echo "All CI jobs passed successfully!"
